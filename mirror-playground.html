<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirror Playground</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        header {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .explanation {
            margin-bottom: 20px;
        }

        .textbox {
            width: 16em;
            height: 30px;
            margin-bottom: 20px;
        }

        .editor-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .editor {
            width: 49%;
            height: 300px;
            border: 1px solid #ccc;
        }

        .scrollable-box {
            width: 99%;
            height: 4em;
            background-color: rgb(235, 235, 235);
            overflow-y: auto; 
            overflow-x: hidden; 
            word-wrap: break-word; 
            padding: 0.5em; 
            box-sizing: border-box;
            border: 1px solid darkgray;
        }

        .button-container {
            margin-bottom: 20px;
        }

        .button-container button {
            padding: 10px 15px;
            margin-right: 10px;
        }

        .status-label {
            font-size: 16px;
            font-weight: bold;
        }

        .validation-results {
            margin: 20px 0;
        }

        .validation-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .validation-table th,
        .validation-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .validation-table th {
            background-color: #f5f5f5;
        }

        .pass {
            color: green;
        }

        .fail {
            color: red;
        }
    </style>
</head>
<body>

<h1>Playground for Mirror</h1>

<p class="explanation">
    The Mirror programming language powered by programming by example and AI.
</p>

<input type="text" class="textbox" id="api-key" placeholder="Your throwaway OpenAI API key">

<div class="editor-container">
    <div id="editor-source" class="editor"></div>
    <div id="editor-intermediate" class="editor"></div>
</div>

<!-- Add new validation results section -->
<div id="validation-results" class="validation-results"></div>

<div class="button-container">
    <button id="button-compile">Compile</button>
    <button id="button-run">Run</button>
</div>

<div class="scrollable-box" id="output"></div>

<br><div class="status-label" id="status">Status: Ready</div><br><br>

<hr>

<h3>Documentation</h3>

<p>See the <a href="https://austinhenley.com/blog/mirrorlang.html">blog post</a> for more information about Mirror.</p>

<p>The Mirror programming language allows you to express behavior <i>only</i> through examples. These examples are then passed to an LLM to generate JavaScript code that satisfies the example behavior (ideally). You can then execute those functions.</p>

<p>The syntax of the language allows function signatures, examples, and function expressions. The only types allowed are <i>number</i>, <i>bool</i>, <i>string</i>, list of any type (e.g., <i>list[bool]</i>), and dictionary.</p>

<p>Please submit any improvements to the GitHub <a href="https://github.com/AZHenley/Mirror">repo</a>.</p>



<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.23.4/src-min-noconflict/ace.min.js"></script>
<script src="mirror.js"></script>
<script>
    var editor1 = ace.edit("editor-source");
    //editor1.setTheme("ace/theme/monokai");
    //editor1.session.setMode("ace/mode/javascript");
    const initialText = `signature foo(x: number, y: number) -> number
example foo(10, 3) = 101010
example foo(1, 1) = 1
example foo(0, 10) = 0

signature bar(x: number) -> string
example bar(9) = "length is 1"
example bar(3210) = "length is 4"

bar(foo(123, 3))`;
    editor1.setValue(initialText);
    editor1.clearSelection();
    editor1.moveCursorTo(0, 0);

    var editor2 = ace.edit("editor-intermediate");
    //editor2.setTheme("ace/theme/monokai");
    editor2.session.setMode("ace/mode/javascript");
    editor2.container.style.background = "lightgray";
    editor2.setReadOnly(true);

    // Compile button action.
    document.getElementById("button-compile").addEventListener("click", async function() {
        const apiKey = document.getElementById("api-key").value;
        if (!apiKey) {
            document.getElementById("status").textContent = "Status: Enter your OpenAI API key."
            return;
        }
        document.getElementById("status").textContent = "Status: Compiling...";
        editor2.setValue("Compiling...")

        const compiler = new MirrorCompiler();
        try {
            const result = await compiler.compile(editor1.getValue(), apiKey);
            editor2.setValue(result.generatedCode);
            editor2.clearSelection();
            
            // Validate examples
            validateExamples(result.generatedCode, result.functions);
            
            document.getElementById("status").textContent = "Status: Response received from OpenAI!";
        } catch (error) {
            editor2.setValue("Error: " + error.message);
            editor2.clearSelection();
            document.getElementById("status").textContent = "Status: API call error!";
        }
    });

    function validateExamples(generatedCode, functions) {
        const resultsDiv = document.getElementById("validation-results");
        resultsDiv.innerHTML = ''; // Clear previous results

        // First eval the generated code to define the functions
        try {
            eval(generatedCode);
        } catch (error) {
            resultsDiv.innerHTML = `<div class="fail">Error evaluating generated code: ${error.message}</div>`;
            return;
        }

        // For each function, create a validation table
        functions.forEach(func => {
            const table = document.createElement('table');
            table.className = 'validation-table';
            
            // Add table header
            const header = `
                <tr>
                    <th colspan="4">Function: ${func.name}</th>
                </tr>
                <tr>
                    <th>Inputs</th>
                    <th>Expected</th>
                    <th>Actual</th>
                    <th>Status</th>
                </tr>
            `;
            table.innerHTML = header;

            // Test each example
            func.examples.forEach(example => {
                const row = document.createElement('tr');
                const actual = eval(`${func.name}(${example.literals.join(', ')})`);
                const passed = JSON.stringify(actual) === JSON.stringify(example.result);
                
                row.innerHTML = `
                    <td>${example.literals.join(', ')}</td>
                    <td>${JSON.stringify(example.result)}</td>
                    <td>${JSON.stringify(actual)}</td>
                    <td class="${passed ? 'pass' : 'fail'}">${passed ? '✓' : '✗'}</td>
                `;
                table.appendChild(row);
            });

            resultsDiv.appendChild(table);
        });
    }

    // Run button action.
    document.getElementById("button-run").addEventListener("click", async function() {
        let jscode = editor2.getValue();
        document.getElementById("output").textContent = eval(jscode);
        document.getElementById("status").textContent = "Status: Executed successfully!";
        // TODO: This will only print the last result. Should we instead print the return value from every function call made by the user (not made by the generated functions)?
    });
</script>
</body>
</html>
