<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirror Playground</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        header {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .explanation {
            margin-bottom: 20px;
        }

        .textbox {
            width: 16em;
            height: 30px;
            margin-bottom: 20px;
        }

        .editor-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .editor {
            width: 49%;
            height: 300px;
            border: 1px solid #ccc;
        }

        .button-container {
            margin-bottom: 20px;
        }

        .button-container button {
            padding: 10px 15px;
            margin-right: 10px;
        }

        .status-label {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<header>Playground for Mirror</header>

<p class="explanation">
    Blah blah blah blah blah.
</p>

<input type="text" class="textbox" id="api-key" placeholder="Your throwaway OpenAI API key">

<div class="editor-container">
    <div id="editor-source" class="editor"></div>
    <div id="editor-intermediate" class="editor"></div>
</div>

<div class="button-container">
    <button id="button-compile">Compile</button>
    <button id="button-run">Run</button>
</div>

<div class="status-label" id="status">Status: Ready</div>

<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.23.4/src-min-noconflict/ace.min.js"></script>
<script src="mirror.js"></script>
<script>
    var editor1 = ace.edit("editor-source");
    //editor1.setTheme("ace/theme/monokai");
    //editor1.session.setMode("ace/mode/javascript");
    const initialText = `signature foo(x: number, y: number) -> number
example foo(10, 3) = 101010
example foo(1, 1) = 1
example foo(0, 10) = 0

foo(123, 3)`;
    editor1.setValue(initialText);
    editor1.clearSelection();
    editor1.moveCursorTo(0, 0);

    var editor2 = ace.edit("editor-intermediate");
    //editor2.setTheme("ace/theme/monokai");
    editor2.session.setMode("ace/mode/javascript");
    editor2.setReadOnly(true);

    // Compile button action.
    document.getElementById("button-compile").addEventListener("click", async function() {
        document.getElementById("status").textContent = "Status: Compile button clicked!";

        // Parse!
        const code = editor1.getValue();
        
        try {
            // Create a new Mirror parser instance and parse the code.
            const parser = new MirrorParser(code);
            const ast = parser.parse();
            const expressions =  extractExpressions(ast);
            const reorganizedAST = groupSignaturesWithExamples(ast);
            
            // Format the AST as a string and display it in editor2.
            const ASToutput = JSON.stringify(ast, null, 2);
            const expressionsoutput =  JSON.stringify(expressions)
            let reorganizedASToutput = JSON.stringify(reorganizedAST)
        
            // For debugging:
            // editor2.setValue(ASToutput + "\n\n@@@\n\n" + expressionsoutput + "\n\n@@@\n\n" + reorganizedASToutput);
            // editor2.clearSelection(); // Clear any selected text.

            document.getElementById("status").textContent = "Status: Code parsed successfully!";
        } catch (error) {
            // Display error in editor2 if parsing fails.
            editor2.setValue("Error: " + error.message);
            editor2.clearSelection();
            document.getElementById("status").textContent = "Status: Parsing error!";
        }

        // Compile!
        const compiler = new MirrorCompiler();
        const apiKey = document.getElementById("api-key").value;
        const prompt = "I want you to generate the function body in JavaScript for the function signature that I give you. I will also give you several examples of inputs with the expected results. Do not use any additional libraries. Do not give any explanation. Only give the function body code, without the outer function definition." // TODO: Inject examples.

        if (!apiKey) {
            document.getElementById("status").textContent = "Status: Enter your OpenAI API key."
            return;
        }

        try {
            const response = await compiler.callOpenAI(apiKey, prompt);
            editor2.setValue(response);
            editor2.clearSelection();
            document.getElementById("status").textContent = "Status: Response received from OpenAI!";
        } catch (error) {
            editor2.setValue("Error: " + error.message);
            editor2.clearSelection();
            document.getElementById("status").textContent = "Status: API call error!";
        }
    });

    // Run button action.
    document.getElementById("button-run").addEventListener("click", async function() {
        document.getElementById("status").textContent = "Status: Run button clicked!";
    });
</script>
</body>
</html>
